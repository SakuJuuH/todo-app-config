name: GitOps Deploy via Dispatch

on:
    repository_dispatch:
        types: [deploy-production, deploy-staging]

env:
    CLUSTER_NAME: dwk-cluster
    GKE_ZONE: europe-west4-a
    REGISTRY: europe-west4-docker.pkg.dev
    PROJECT_ID: ${{ secrets.GKE_PROJECT }}
    GKE_CREDENTIALS: ${{ secrets.GKE_SA_KEY }}
    DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
    update-kustomization:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5.0.0
              with:
                  ref: main
                  fetch-depth: 0
            - name: Map environment
              run: |
                  if [[ "${{ github.event.action }}" == "deploy-production" ]]; then
                    echo "ENV=production" >> $GITHUB_ENV
                  elif [[ "${{ github.event.action }}" == "deploy-staging" ]]; then
                    echo "ENV=staging" >> $GITHUB_ENV
                  fi
            - name: Validate event type
              run: |
                  if [[ -z "${{ env.ENV }}" ]]; then
                    echo "Unknown event type: ${{ github.event.action }}"
                    exit 1
                  fi
            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v3
              with:
                  credentials_json: "${{ env.GKE_CREDENTIALS }}"
            - name: Set up Google Cloud SDK
              uses: google-github-actions/setup-gcloud@v3

            - name: Configure Docker
              run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet
            - name: Get GKE credentials
              uses: google-github-actions/get-gke-credentials@v2
              with:
                  cluster_name: ${{ env.CLUSTER_NAME }}
                  project_id: ${{ env.PROJECT_ID }}
                  location: ${{ env.GKE_ZONE }}
            - name: Set up Kustomize
              uses: imranismail/setup-kustomize@v2.1.0

            - name: Update image tags
              run: |
                  kubectl create namespace ${{ env.ENV }} || true
                  kubectl config set-context --current --namespace=${{ env.ENV }}
                  cd overlays/${{ env.ENV }}
                  kustomize edit set image ${{ github.event.client_payload.frontend_image }}
                  kustomize edit set image ${{ github.event.client_payload.todo_service_image }}
                  kustomize edit set image ${{ github.event.client_payload.image_service_image }}
                  kustomize edit set image ${{ github.event.client_payload.broadcaster_service_image }}
                  kustomize build . | kubectl apply -f -
                  kubectl set env deployment/broadcaster-service DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }} -n ${{ env.ENV }}

            - name: Commit updated kustomization.yaml
              uses: EndBug/add-and-commit@v9
              with:
                  default_author: github_actions
                  add: "overlays/${{ env.ENV }}/kustomization.yaml"
                  message: "New version released for ${{ env.ENV }}: ${{ github.sha }}"
